//Постановка задачи: 
//При обновлении требуется сверять текст процедур и функций между основной конфигурацией и расширением. 
//Вручную это делается путем сохранения процедуры и функции из основной конфигурации / из расширения и сравнения инструментом сравнения файлов.

//Требуется сохранять тексты на диск основной конфигурации и расширения. 
//Откуда берутся требуемые для сохранения процедуры и функции: документ "Изменения конфигурации" - написан в расширении. 

//ниже процедура обработки документа изменения.
Процедура ОбработатьДокументИзменения(параметры,ДокИзменения)

	параметры.МестоИзменений = ДокИзменения.МестоИзменений;
	параметры.КаталогМестаИзменения = параметры.МестоИзменений.ПутьККаталогу;	
	Для каждого строка Из ДокИзменения.ОписаниеИзменений  Цикл
		
		Если ЗначениеЗаполнено(строка.ПроцедураФункцияОсновной) и ЗначениеЗаполнено(строка.ПутьКФайлуИзменений) Тогда
			
			Если СтрДлина(строка.ПроцедураФункцияОсновной.Наименование)<>0 Тогда
				
				ЗаписатьТекстПроцедурыИФункцииИзФайла(параметры,строка,ложь);
				ЗаписатьТекстПроцедурыИФункцииИзФайла(параметры,строка,истина);
				
			КонецЕсли; 
			
			
		КонецЕсли; 		
	КонецЦикла; 	

КонецПроцедуры

//в строке 19 и 20 обрабатывам строку документа, в строке документа хранится так.
//ниже одна из обрабатываемых строк документа
//N	Объект изменений	Место в объекте	Имя формы / макета СКД	Процедура функция	Нотация расширенной процедуры	Процедура функция основной	Комментарий	Комментарий к доработке	Работает	Задача проекта	Путь к файлу изменений
//1	Справочник.ДоговорыКонтрагентов	Модуль формы	Справочник.ДоговорыКонтрагентов.ФормаСпискаОбщая	ОЦО_ПриСозданииНаСервере() P()	Изменение и контроль	"ПриСозданииНаСервере" P()	"ПриСозданииНаСервере"		Нет		D:\OneDrive\_2021\103_ОЦО\UNPACK\SSC_PO\Catalogs\ДоговорыКонтрагентов\Forms\ФормаСпискаОбщая\Ext\Form\Module.bsl
//Структуру полей документа можно посмотреть тут
//https://github.com/Kindman1980/1C_Search_SPPR/wiki/ConfigurationChanges_Document

//Ниже процедура - записать текст процедуры и функции из файла в отдельный файл.

Процедура ЗаписатьТекстПроцедурыИФункцииИзФайла(параметры,строка,израсширения)

	//1.подмена пути
	ПодкаталогПутиМестаИзменений = СтрЗаменить(строка.путьКФайлуИзменений,параметры.КаталогместаИзменения,""); //"Catalogs\ДоговорыКонтрагентов\Forms\ФормаСпискаОбщая\Ext\Form\Module.bsl"
	
	Если израсширения Тогда
	
		МестоИзменения =параметры.МестоИзменений.Наименование;
		Путь = строка.путьКФайлуИзменений; //"D:\OneDrive\_2021\103_ОЦО\UNPACK\SSC_PO\Catalogs\ДоговорыКонтрагентов\Forms\ФормаСпискаОбщая\Ext\Form\Module.bsl"
		НаименованиеПроцедурыФункции = РаботаСТекстомКлиентСервер_ДВС.ВыделитьНаименованиеПроцедурыФункции(строка.процедурафункция.наименование);
		ТипПроцедурыФункции = строка.процедурафункция.ТипПроцедураИлиФункция;
		
		Иначе
		МестоИзменения = "Основная";
		Путь = Параметры.Путь+"\"+ПодкаталогПутиМестаИзменений;
		
		НаименованиеПроцедурыФункции = РаботаСТекстомКлиентСервер_ДВС.ВыделитьНаименованиеПроцедурыФункции(строка.процедурафункцияосновной.наименование);
		//НаименованиеПроцедурыФункции = СтрЗаменить(строка.процедурафункцияосновной.наименование,"()","");  //"D:\CPM_3_1_7_2\Catalogs\ДоговорыКонтрагентов\Forms\ФормаСпискаОбщая\Ext\Form\Module.bsl"
		ТипПроцедурыФункции = строка.процедурафункцияосновной.ТипПроцедураИлиФункция;
		
	КонецЕсли; 
	
	//ПодкаталогСохраненияПроцедурыФункции = СтрЗаменить(ПодкаталогПутиМестаИзменений,"\","_");
	ПутьДляСохраненияПроцедурыФункции = "D:\CPM_Changes\"+ПодкаталогПутиМестаИзменений;  //"D:\CPM_Changes\Catalogs\ДоговорыКонтрагентов\Forms\ФормаСпискаОбщая\Ext\Form\Module.bsl"
	//ПутьДляСохраненияПроцедурыФункции = "D:\CPM_Changes\"+ПодКаталогСохраненияПроцедурыФункции+"\"; //"D:\CPM_Changes\Catalogs_ДоговорыКонтрагентов_Forms_ФормаСпискаОбщая_Ext_Form_Module.bsl\"
	
	
	//2.Открываем текстовый файл
	
	Если ТипПроцедурыФункции = перечисления.ДВС_ТипПроцедураФункция.Процедура Тогда
	СтрокаПоиска = "Процедура "+НаименованиеПроцедурыФункции;			
	Тип=перечисления.ДВС_ТипПроцедураФункция.Процедура;	
	Иначе	
	СтрокаПоиска = "Функция "+НаименованиеПроцедурыФункции;
	тип=Перечисления.ДВС_ТипПроцедураФункция.Функция;
	КонецЕсли; 
	
	Текст = Новый ТекстовыйДокумент;
	Попытка
	Текст.Прочитать(Путь,КодировкаТекста.UTF8);
	Количествострок = текст.КоличествоСтрок();
	
	НачСтрока=0;
	
	Для стр=1  По Количествострок  Цикл
		СтрокаДляРазбора = Текст.ПолучитьСтроку(Стр);		
		
		Если СтрНайти(Нрег(СтрокаДляРазбора),НРег(строкапоиска))>0 Тогда
			НачСтрока = стр;
			прервать;
		КонецЕсли; 
	КонецЦикла;
	
	Если НачСтрока>0 Тогда
		ТекстПроцедурыФункции = "";	
		СтрокаКонца = ?(тип=перечисления.ДВС_ТипПроцедураФункция.Процедура,"КонецПроцедуры","КонецФункции");
		
		Для стр=начстрока По Количествострок  Цикл
			
			СтрокаТекста= Текст.ПолучитьСтроку(Стр);
			Если не СтрНайти(нрег(СтрокаТекста),Нрег(СтрокаКонца)) Тогда
				ТекстПроцедурыФункции = ТекстПроцедурыФункции+строкатекста+Символы.ПС;
			Иначе	
				ТекстПроцедурыФункции = ТекстПроцедурыФункции+СтрокаКонца;
				прервать;
				
			КонецЕсли; 
			
			
		КонецЦикла; 
			
	ДобавитьЗаписьВРегистрСведений(Путь,параметры,ТекстПроцедурыФункции,строка);	
	
	ИмяПроцедурыФункции = параметры.версия+"_"+МестоИзменения+"_"+НаименованиеПроцедурыФункции+".txt";
	
	СоздатьКаталог(ПутьДляСохраненияПроцедурыФункции);
	РаботаСТекстомКлиентСервер_ДВС.ЗаписатьТекстовыйФайл(ПутьДляСохраненияПроцедурыФункции+"\"+ИмяПроцедурыФункции,ТекстПроцедурыФункции);
	
	
	КонецЕсли;  
	Исключение
	Сообщить("Каталог не обнаружен!");
	КонецПопытки;

	
	

КонецПроцедуры

//Посмотрите видео как это выполняется.


